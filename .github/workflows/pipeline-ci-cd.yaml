name: 'Terraform Build DevOps01-Project'
on:
  push:
    branches:
      - "main"
  pull_request:
    branches:
      - "main"
jobs:

  #Determines the type of machine to run the job on
  terraform:
    name: 'TF GitHub Actions DevOps01-Project'
    runs-on: ubuntu-latest
    
    #The environment that the job references
    environment: production
    
    #Define default shell and working-directory options for all run steps in a workflow
    defaults:
      run:
        shell: bash
    
    steps:
    #Checks out repository under $GITHUB_WORKSPACE, so your workflow can access it
    - name: Checkout
      uses: actions/checkout@v2

    #Is a JavaScript action that sets up Terraform CLI
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v1
      with:
        terraform_version: latest
        
    #To ensure access to the AWS Cloud environment we must configure and in the runner environment.
    - name: Configure AWS Credentials
      run: |
        echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
        echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
        echo "AWS_REGION=us-east-1" >> $GITHUB_ENV

    #We can now configure Terraform commands
    - name: Terraform Init
      id: init
      run: |
        terraform init

    #Checks whether the configuration has been properly formatted
    #It will throw an error if the configuration isn't properly formatted
    - name: Terraform Format
      id: fmt
      run: |
        terraform fmt -check
      env:
        TF_ACTION_WORKING_DIR: .
      continue-on-error: true

    #Validates the configuration used in the GitHub action workflow
    - name: Terraform Validate
      id: validate
      run: |
        terraform validate -no-color

    #Generates a Terraform plan
    - name: Terraform Plan Status
      if: steps.plan.outcome == 'failure'
      run: |
        exit 1

    #Applies the configuration when a commit is pushed to 'main'
    - name: Terraform Apply
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      run: |
        terraform apply -auto-approve

  #Deploy the LMS Docker container to the provisioned EC2 instance
  deploy:
      runs-on: ubuntu-latest

      steps:
        - name: Checkout Repository
          uses: actions/checkout@v2
        
        - name: Set up SSH
          uses: webfactory/ssh-agent@v0.8.0
          with:
            ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
        #Pull the image from Docker Hub      
        - name: Pull Docker Image
          run: |
            docker login -u ${{ secrets.DOCKER_USERNAME }} -p ${{ secrets.DOCKER_PASSWORD }}
            docker pull bitnami/moodle:latest
            
        #Deploy Docker Container
        - name: Deploy Docker Container
          run: |
            # SSH into your EC2 instance and start the Docker container
            ssh -i /tmp/ssh_key -o StrictHostKeyChecking=no ec2-user@YOUR_EC2_IP_ADDRESS 'docker run -d -p 80:80 bitnami/moodle:latest'
          continue-on-error: true

        #Checking if the Docker container is already running
        - name: Check if Container is Running
          run: |
            CONTAINER_STATUS=$(ssh -i /tmp/ssh_key -o StrictHostKeyChecking=no ec2-user@YOUR_EC2_IP_ADDRESS 'docker ps -q --filter "ancestor=bitnami/moodle:latest"')
            if [ -n "$CONTAINER_STATUS" ]; then
              echo "Container is already running. Stopping and removing it."
              ssh -i /tmp/ssh_key -o StrictHostKeyChecking=no ec2-user@YOUR_EC2_IP_ADDRESS "docker stop $CONTAINER_STATUS"
              ssh -i /tmp/ssh_key -o StrictHostKeyChecking=no ec2-user@YOUR_EC2_IP_ADDRESS "docker rm $CONTAINER_STATUS"
            fi
          continue-on-error: true
        
        #Check Container Deployment Status
        - name: Check Container Deployment Status
          run: |
            DEPLOYMENT_STATUS=$(ssh -i /tmp/ssh_key -o StrictHostKeyChecking=no ec2-user@YOUR_EC2_IP_ADDRESS 'docker ps -q --filter "ancestor=bitnami/moodle:latest"')
            if [ -n "$DEPLOYMENT_STATUS" ]; then
              echo "Container deployed successfully."
            else
              echo "Container deployment failed."
              exit 1
            fi
        
